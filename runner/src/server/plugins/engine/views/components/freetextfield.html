{% from "character-count/macro.njk" import govukCharacterCount %}
{% macro FreeTextField(component) %}

<head>
  <script src="/assets/tinymce.min.js"></script>
  <script type="text/javascript">

    tinymce.init({
      setup: function (editor) {
        editor.on('init', function () {          
          setWordCount(editor);
        });
        editor.on('input', function (e) {          
          setWordCount(editor);
        });
        editor.on('setcontent', function(e) {         
          setWordCount(editor);
        });
      },
      selector: '.myeditablediv',  // change this value according to your HTML
      skin: 'tinymce-5',
      branding: false,
      elementpath: false,
      content_css: 'default',
      height: 150,
      menubar: false,      
      browser_spellcheck: true,
      max_words: Number('{{ component.model.maxwords }}'),
      iframe_aria_text: '{{ component.model.name }}',
      paste_data_images: false,
      dragover_callback: function (e) {
        e.preventDefault(); // prevent dragover event from doing anything, images could be snuck in this way
      },
      drop_callback: function (e) {
        e.preventDefault(); // prevent drop event from doing anything, images could be snuck in this way
      },
      plugins: [
        'advlist', 'autolink',
        'lists', 'link', 'charmap', 'preview', 'anchor', 'searchreplace',
        'fullscreen', 'insertdatetime', 'table', 'help'
      ],
      toolbar: 'bold | bullist numlist',
      contextmenu: 'paste'
    });

    function countWords(editor) {      
      var content = editor.getContent({ format: 'text' });
      var noLineBreaksContent = content.replace(/(\r\n|\n|\r)/gm, " ");
      var wordCount = 0;
      if (content) {
        var matches = noLineBreaksContent.match(/\b\w+\b/g);
        wordCount = matches ? matches.length : 0;
      }
      return wordCount;
    }

    function setWordCount(editor) {            
      var maxWords = editor.getParam('max_words', 500);
      var wordCount = countWords(editor);
      var wordsRemaing = Number(maxWords) - wordCount;
      var label = document.getElementById('word-count-label-' + editor.id);
      label.innerHTML = 'You have ' + wordsRemaing + ' words remaining';
      label.style.color = '#505a5f';      
      if (wordsRemaing < 0) {
        var wordsOver = wordCount - Number(maxWords);
        label.innerHTML = 'You have ' + wordsOver + ' words too many';
        label.style.color = '#d4351c';
        editor.dom.addClass(editor.getContainer(), 'red-border');
      }
      else{
        editor.dom.removeClass(editor.getContainer(), 'red-border');
      }
    }
  </script>
</head>
<div class="govuk-form-group govuk-character-count {{ 'govuk-form-group--error' if component.model.errorMessage }}"
  data-module="govuk-character-count" data-maxwords="150">
  <label class="govuk-label govuk-label--s" for={{component.model.id}}>{{component.model.label.text}}</label>
  <div id="hint-{{component.model.id}}" class="govuk-hint">{{component.model.hint.html}}</div>
  {% if component.model.errorMessage %}
  <span id="nationality-error" class="govuk-error-message">
    <span class="govuk-visually-hidden">Error:</span> {{component.model.errorMessage.text}}
  </span>
  {% endif %}
  <textarea id="{{ component.model.id }}" name="{{ component.model.name }}" rows="5" class="govuk-textarea myeditablediv">{{ component.model.value }}</textarea>
  <div id="word-count-label-{{ component.model.id }}" class="govuk-hint govuk-js-character-count">You can enter up to {{
    component.model.maxwords }} words</div>
</div>

{% endmacro %}